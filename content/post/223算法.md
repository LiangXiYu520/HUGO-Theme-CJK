---
author: "柯棋瀚"
title: "Hugo文章推薦算法舉例"
date: 2020-04-14
lastmod: 2020-04-17
categories: ["站務"]
tags: ["統計","coding"]
url: /223
markdown: 'https://github.com/kujihhoe/blogflex/blob/master/content/post/223算法.md'
description: '經過艱苦卓絕的試驗，網站第四版終於完工了！現在介紹一下本站各類推薦中用到的算法。本人不懂編程，這裏只是瞎貓撞上死耗子。源碼直接在我 <a href="https://github.com/kujihhoe/blogflex" targrt="_blank">Github</a> 上找就可以，分別在 home.html 和 single.html<br>
examples for article recommendation in Hugo'
vertical: false
---

本站的索引 taxonomies 有分類 categories、系列 series、標籤 tags、作者 author、備註 notes。每篇文章都有 1 箇分類、0-1 個系列、0-3 個標籤、0-1 箇備註。分爲博客、作品、赫赫讚府、春秋學刊 4 個 `section`。

# 一級難度

從簡單的開始說。以下都是主葉中的。

## 作品

<img src="https://pic.imgdb.cn/item/5e952d72c2a9a83be5821683.jpg">

「作品」的 `section` 是 `gallery`。按修改時間倒序列出所有 `type` 是 `gallery` 的文章：

```html
{{ range  (where .Site.RegularPages.ByLastmod.Reverse "Type" "gallery") }}
    <a href="{{ .Permalink }}">{{ .Title }}</a>
{{ end }}
```

# 二級難度

## 最近修改

<img src="https://pic.imgdb.cn/item/5e952d72c2a9a83be582167f.jpg">

思路如下：

1. 按最近修改時間倒序，列出所有文章
2. 篩選出所有發布時間和修改時間不一致的文章
3. 列出前 15 項

```html
{{ $lastmod := slice }}
{{ range   (where .Site.RegularPages.ByLastmod.Reverse "Type" "post")  }}
    {{ if ne .Lastmod .Date }}
        {{ $lastmod =$lastmod | append . }}
    {{ end }}
{{ end }}
{{ range first 15 $lastmod }}
    <a href="{{ .Permalink }}">{{ .Title }}</a>
{{ end }}
```

最簡單的方法就是直接按修改時間倒序列出，但是大部分都會和最近發布重複，就顯得沒意義了。

## 其他作者

<img src="https://pic.imgdb.cn/item/5e952d72c2a9a83be5821686.jpg" width="400">

同理，還有其他作者：

1. 列出所有作者
2. 篩選出不是「柯棋瀚」「柯棋瀚整理」的作者
3. 隨機列出這些作者及他們的文章

```html
{{ $author := slice }}
{{ range .Site.Taxonomies.author.ByCount }}
    {{ if ne .Page.Title  "柯棋瀚" "柯棋瀚整理" }}
        {{ $author = $author | append . }}
    {{ end }}
{{ end }}
{{ range $author  | shuffle  }}
    <a href="{{ .Page.RelPermalink }}">{{ .Page.Title }}</a>
    {{ range .Pages  | shuffle }}
        <li><a href="{{ .Permalink }}">{{ .Title }}</a></li>
    {{ end }}
{{ end }}
```

岔開一句，單篇文章的 `{{ .Params.author }}` 顯示的是 `abc`，而 `{{ .Params.categories }}`  `{{ .Params.series }}` 顯示的是 `[abc]`，卽 `[]string` 而非 `string`。眞是坑。

## 分類

我想在每個分類下面生成兩項最近發布和兩項隨機推薦。思路如下：

1. 隨機排列所有分類
2. 生成兩項最近發布
3. 生成該分類下所有文章，並隨機排序
4. 生成 1 和 2 的補集
5. 生成前兩項 3

```html
{{ range $categories.ByCount  | shuffle }}
    <h2><a href="{{ .Page.Permalink }}" target="_blank">{{ .Page.Title | safeHTML  }}</a></h2>
    <div>最近發布</div>
    {{ $1end :=slice }}
    {{ range first 2 .Pages }}
        {{ $1end = $1end | append . }}
        <a href="{{ .Permalink }}">{{ .Title | safeHTML  }}</a>
    {{ end }}
    <div>隨機推薦</div>
    {{ $2end := slice }}
    {{ with .Pages | shuffle }}
        {{ $2categories := . }}
        {{ range  $2categories }}
           {{ $2end =  $2end | append  . }}
        {{ end }}
    {{ end }}
    {{ $3end := slice }}
    {{ range $2end }}
        {{ $3end = $2end | complement $1end  }}
    {{  end }}
    {{ range first 2 $3end  }}
        <a href="{{ .Permalink }}">{{ .Title | safeHTML  }}</a>
    {{ end }}
{{ end }}
```

隨機推薦下面一行有個坑，如果直接寫成這樣：

```
{{ range .Site.Taxonomies.categories.ByCount }}
    {{ range first 1 .Pages | shuffle }}  
        {{ $categories =  $categories | append  . }}
    {{ end }}
{{ end }}
```

是不能隨機的，產生的都是各分類中發布時間最近的一項文章。所以我用了迂迴的方法。

# 三級難度

以下是各文章下面的推薦。

<img src="https://pic.imgdb.cn/item/5e952d72c2a9a83be5821688.jpg" width="700">

## 您可能喜歡

**是從 [ops.tips](https://ops.tips/blog/article-recommendation-using-hugo/) 那移植過來的**，非常感謝。（安利一句，這網站挺好看的）他只算了 `tags`，我加上了 `categories`、`series`。`notes` 不列入計算。

本站的情況是，如果兩篇文章的系列相同，那關聯度是最高的，我們可以據此設置 **加權**，系列占 4，分類、標籤占 3。有如下可能：

| 分類 3 | 系列 4 | 標籤 3 | 總分 |
| ------ | ------ | ------ | ---- |
| 0      | 0      | 0      | 0    |
| 0      | 0      | 1      | 3    |
| 0      | 0      | 2      | 6    |
| 0      | 0      | 3      | 9    |
| 0      | 1      | 0      | 4    |
| 0      | 1      | 1      | 7    |
| 0      | 1      | 2      | 10   |
| 0      | 1      | 3      | 13   |
| 1      | 0      | 0      | 3    |
| 1      | 0      | 1      | 6    |
| 1      | 0      | 2      | 9    |
| 1      | 0      | 3      | 12   |
| 1      | 1      | 0      | 7    |
| 1      | 1      | 1      | 10   |
| 1      | 1      | 2      | 13   |
| 1      | 1      | 3      | 16   |

`0,3,4,6,7,9,10,12,13,16` 10 種情況。我們設置 `3` `4` `6` `7` `9` `10` `13` 7 檔。

思路如下：

1. 列出本文章之外的所有文章
2. 加權計算本文章和其他文章的索引重合度
3. 按索引重合數量進行排序
4. 列出前 10 項

```html
{{ $current := . }}
{{ $articles := where (where $.Site.Pages ".Kind" "eq" "page" ) ".Title" "!=" $current.Title }}
{{ $3relevant := slice }}
{{ $4relevant := slice }}
{{ $6relevant := slice }}
{{ $7relevant := slice }}
{{ $9relevant := slice }}
{{ $10relevant := slice }}
{{ $13relevant := slice }}
{{ $recommend := slice }}
{{ range $idx, $article := $articles }}
    {{ $1intersection := len (intersect $article.Params.series $current.Params.series) }}
    {{ $1weighted := mul 4 $1intersection }}
    {{ $2intersection := len (intersect $article.Params.categories $current.Params.categories) }}
    {{ $2weighted := mul 3 $2intersection }}
    {{ $3intersection := len (intersect $article.Params.tags $current.Params.tags) }}
    {{ $3weighted := mul 3 $3intersection }}
    {{ $4weighted  := add $1weighted $2weighted }}
    {{ $5weighted  := add $3weighted $4weighted }}
    {{ if (ge $5weighted 13) }}
        {{ $13relevant = $13relevant | append $article }}
        {{ else if (ge $5weighted 10) }}
            {{ $10relevant = $10relevant | append $article }}
        {{ else if (eq $5weighted 9) }}
            {{ $9relevant = $9relevant | append $article }}
        {{ else if (eq $5weighted 7) }}
            {{ $7relevant = $7relevant | append $article }}
        {{ else if (eq $5weighted 6) }}
            {{ $6relevant = $6relevant | append $article }}
        {{ else if (eq $5weighted 4) }}
            {{ $4relevant = $4relevant | append $article }}
        {{ else if (eq $5weighted 3) }}
            {{ $3relevant = $3relevant | append $article }}
        {{ end }}
{{ end }}
{{ range $13relevant }}
    {{ $recommend = $recommend | append . }}
{{ end }}
{{ range $10relevant }}
    {{ $recommend = $recommend | append . }}
{{ end }}
{{ range $9relevant }}
    {{ $recommend = $recommend | append . }}
{{ end }}
{{ range $7relevant }}
    {{ $recommend = $recommend | append . }}
{{ end }}
{{ range $6relevant }}
    {{ $recommend = $recommend | append . }}
{{ end }}
{{ range $4relevant }}
    {{ $recommend = $recommend | append . }}
{{ end }}
{{ range $3relevant }}
     {{ $recommend = $recommend | append . }}
{{ end }}
<ul>
{{- range (first 10 $recommend ) -}}
<li><a href="{{ .Permalink }}">{{- .Title -}}</a></li>
{{ end }}
</ul>
```

以 [蒙文通的經史觀——<v>經學抉原</v>讀後（附摘錄）](blog/2018/10/29/mgwfts.html) 為例。未加權：

- 錢穆<v>經學通論</v>摘錄
- 陳壁生諸書摘錄
- 周予同諸篇摘錄
- <v>北京讀經說記</v>述要
- 梁啓超<v>中國近三百年學術史</v>述要
- 鄭玄地位的升降——<v>禮是鄭學</v>讀後
- 蔗糖消費的社會性——<v>甜與權力</v>讀後
- 維柯與康德的史學思想——<v>新科學</v>讀後
- 霍布斯鮑姆筆下的蘇聯模式──<v>極端的年代</v>讀後
- <v>公羊傳</v>齊襄復讎事詮釋史

加權之後：

- 錢穆<v>經學通論</v>摘錄
- 陳壁生諸書摘錄
- 周予同諸篇摘錄
- <v>北京讀經說記</v>述要
- 梁啓超<v>中國近三百年學術史</v>述要
- 鄭玄地位的升降——<v>禮是鄭學</v>讀後
- 蔗糖消費的社會性——<v>甜與權力</v>讀後
- 維柯與康德的史學思想——<v>新科學</v>讀後
- 霍布斯鮑姆筆下的蘇聯模式──<v>極端的年代</v>讀後
- 艾因哈德筆下的査理大帝——<v>査理大帝傳</v>讀後

區別不大。只有最後一項不一樣，被換成了讀書筆記。

## 沒有喜歡的？這裏呢

在此基礎上，我們可以有代表性地生成與此不相關的文章：

1. 列出所有分類，每個分類隨機產生一項文章
2. 生成所有不是本文章，分類系列有重合的文章，及其他 `section` 的文章
3. 生成 1 和 2 的交集
4. 在這一交集中隨機產生 5 項文章

```html
{{ $categories := slice }}
{{ range .Site.Taxonomies.categories.ByCount }}
    {{ with .Pages | shuffle }}
        {{ $cate := . }}
        {{ range first 1 $cate }}
            {{ $categories =  $categories | append  . }}
        {{ end }}
    {{ end }}
{{ end }}
{{ $current := slice }}
{{ $current = $current | append . }}
{{ $other := $.Site.RegularPages |  complement $current $recommendedArticles (where .Site.RegularPages "Type" "gallery") (where .Site.RegularPages "Type" "block")  (where .Site.RegularPages "Type" "zanfu") (where .Site.RegularPages "Type" "xuekan") | shuffle }}
{{ $others := intersect  $categories  $other }}
<ul>
    {{  range first 5 $others | shuffle }}
        <li><a href="{{ .Permalink }}">{{- .Title -}}</a></li>
    {{ end }}
</ul>
```

# 推廣

如果配合 GitHub Actions，定時重新生成，那這些隨機的推薦可以讓靜態網頁變成半動態網頁，豈不美哉！
