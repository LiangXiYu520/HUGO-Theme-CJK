{{ define "main" }}
<body>
  <main>
  <article>
    <div class="heading-wrap">
    {{ partial "heading.html" . }}
    <div class="tag">
    <div class="des1">
    <time datetime="{{ .Date.Format "2006-01-02" }}">
  {{ .Date.Format "2006-01-02" }}
{{ if ne .Date .Lastmod }}> {{ .Lastmod.Format "2006-01-02" }}{{ end }}</time>　
  <span>{{- .WordCount }} 字</span>
  {{ if $.Site.Params.linkToMarkDown -}}
  {{ if .Params.markdown }}
  <span class="svg"><a  href="{{ .Params.markdown | safeHTML }}"  target="_blank"><svg  xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512">
      <path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path>
    </svg></a></span>
    {{ end }}
    {{ end }}
    </div>
    {{- $author_id := .Params.author | default .Site.Author.name -}}
    {{- $author := (index ($.Site.Data.author | default dict) $author_id) -}}
    {{- $author_lang := (index ($author | default dict) .Site.Language.Lang) -}}
    {{- $author_name := $author_lang.name.display | default $author.name.display | default $author_id -}}
    <div class="des1">{{- with $.Site.GetPage "taxonomy" (printf "author/%s" $author_id) -}}
    <span class="des2">作者</span> <a href="/author/{{ $author_name }}">@{{- $author_name | safeHTML -}}</a>
    {{- else -}}
    <span class="des2">作者</span> <a href="/author/{{ $author_name }}">@{{- $author_name | safeHTML -}}</a>
    {{ end }}
    {{- with .Params.series -}}
        　<span class="des2">系列</span>
        {{ range . }}
        {{- $name := . -}}
        {{- with $.Site.GetPage "taxonomy" (printf "series/%s" $name) | default ($.Site.GetPage "taxonomy" (printf "series/%s" ($name | urlize))) -}}
        <span class="des1-cate"> <a href="/series/{{ $name }}">{{- $name -}}｜</a></span>
        {{- end -}}
        {{- end -}}
    {{- end -}}
    {{- with .Params.tags -}}
        　<span class="des2">標籤</span>
        {{ range . }}
        {{- $name := . -}}
        {{- with $.Site.GetPage "taxonomy" (printf "tags/%s" $name) | default ($.Site.GetPage "taxonomy" (printf "tags/%s" ($name | urlize))) -}}
        <span class="des1-cate"><a href="/tags/{{ $name }}">#{{- $name -}}</a></span>
        {{ end -}}
        {{ end }}
    {{- end }}
    {{- with .Params.notes -}}
        　<span class="des2">備註</span>
        {{ range . }}
        {{- $name := . -}}
        {{- with $.Site.GetPage "taxonomy" (printf "notes/%s" $name) | default ($.Site.GetPage "taxonomy" (printf "notes/%s" ($name | urlize))) -}}
        <span class="des1-cate"><a href="/notes/{{ $name }}">({{- $name -}})</a></span>
        {{ end -}}
        {{ end }}
    {{- end }}
  </div>
<div class="des1">
    {{- if .Params.contentCopyright -}}
    <span class="des2">版權 </span>{{ .Params.contentCopyright | safeHTML }}
    {{- else -}}
    <span class="des2">版權 </span>{{ .Site.Params.contentCopyright | safeHTML }}
    {{- end -}}
</div>
</div>
    <div class="pagi-wrap">
    <div class="pagi">
      {{ with .PrevInSection }}
        <span class=".pagi-prev">← <a href="{{ .RelPermalink }}">{{ .Title | safeHTML  }}</a></span>
        {{- end }}
    {{ with .NextInSection }}
          <span class=".pagi-next"><a href="{{ .RelPermalink }}">{{ .Title  | safeHTML }}</a> →</span>
    {{- end }}
    </div>
  </div>
    </div>
{{ if or .Params.vertical (and .Site.Params.vertical (ne .Params.vertical false)) }}
<div class="vertical-wrap">
  <div class="toc">
{{ if .TableOfContents }}
<li class="toc-item">{{ .TableOfContents }}</li>
{{ end }}
</div>
    <div class="vertical">
    {{ .Content }}
    </div>
  </div>
      {{ else }}
  <div class="content">
    {{ if .TableOfContents }}
      <div class="toc sticky">
      <li class="toc-item">{{ .TableOfContents }}</li>
    </div >
    {{ end }}
         <div class="vertical-false">
            {{ .Content }}
          </div>

      </div>
    {{ end }}
<div class="Tags  recommend" >
  {{ $current := . }}
  {{ $articles := where (where $.Site.Pages ".Kind" "eq" "page" ) ".Title" "!=" $current.Title }}
  {{ $3relevant := slice }}
  {{ $4relevant := slice }}
  {{ $6relevant := slice }}
  {{ $7relevant := slice }}
  {{ $9relevant := slice }}
  {{ $10relevant := slice }}
  {{ $13relevant := slice }}
  {{ $recommend := slice }}
  {{ $1recommend := slice }}
  {{ $2recommend := slice }}
  {{ $3recommend := slice }}
  {{ $4recommend := slice }}
  {{ range $idx, $article := $articles }}
  {{ $1intersection := len (intersect $article.Params.series $current.Params.series) }}
  {{ $1weighted := mul 4 $1intersection }}
  {{ $2intersection := len (intersect $article.Params.categories $current.Params.categories) }}
  {{ $2weighted := mul 3 $2intersection }}
  {{ $3intersection := len (intersect $article.Params.tags $current.Params.tags) }}
  {{ $3weighted := mul 3 $3intersection }}
  {{ $4weighted  := add $1weighted $2weighted }}
  {{ $5weighted  := add $3weighted $4weighted }}
  {{ if (ge $5weighted 13) }}
  {{ $13relevant = $13relevant | append $article }}
  {{ else if (ge $5weighted 10) }}
  {{ $10relevant = $10relevant | append $article }}
  {{ else if (eq $5weighted 9) }}
  {{ $9relevant = $9relevant | append $article }}
  {{ else if (eq $5weighted 7) }}
  {{ $7relevant = $7relevant | append $article }}
  {{ else if (eq $5weighted 6) }}
  {{ $6relevant = $6relevant | append $article }}
  {{ else if (eq $5weighted 4) }}
  {{ $4relevant = $4relevant | append $article }}
  {{ else if (eq $5weighted 3) }}
    {{ $3relevant = $3relevant | append $article }}
  {{ end }}
  {{ end }}
  {{ range $13relevant }}
      {{ $recommend = $recommend | append . }}
  {{ end }}
  {{ range $10relevant }}
      {{ $recommend = $recommend | append . }}
  {{ end }}
  {{ range $9relevant }}
      {{ $recommend = $recommend | append . }}
  {{ end }}
  {{ range $7relevant }}
      {{ $recommend = $recommend | append . }}
  {{ end }}
  {{ range $6relevant }}
      {{ $recommend = $recommend | append . }}
  {{ end }}
  {{ range $4relevant }}
      {{ $recommend = $recommend | append . }}
  {{ end }}
  {{ range $3relevant }}
       {{ $recommend = $recommend | append . }}
  {{ end }}
    {{- range first 5 $recommend -}}
      {{ $1recommend = $1recommend | append . }}
    {{ end }}
  {{ range first 20 $recommend | shuffle }}
  {{ $2recommend = $2recommend | append . }}
  {{ end }}
  {{ $3recommend = $2recommend | complement  $1recommend }}
{{ range first 5 $3recommend }}
{{ $4recommend = $4recommend | append . }}
  {{ end }}
  <div class="recommend1">
  <h2>您可能喜歡 <span style="font-size:.6em;font-weight:400">據索引重合度加權排序</span></h2>
  <ul>
    {{- range $1recommend -}}
    <li>
      <a href="{{ .Permalink }}">{{- .Title  | safeHTML -}}</a>
    </li>
    {{ end }}
  {{- range $4recommend -}}
  <li>
    <a href="{{ .Permalink }}">{{- .Title  | safeHTML -}}</a>
  </li>
  {{ end }}
  </ul>
</div>
<div class="recommend1">
  {{ $current := slice }}
  {{ $current = $current | append . }}
  <h2>沒有喜歡的？ <span style="font-size:.6em;font-weight:400">其他分類各隨機生成一項</span></h2>
{{ $other := $.Site.RegularPages |  complement $current $recommend (where .Site.RegularPages "Type" "gallery") (where .Site.RegularPages "Type" "block")  (where .Site.RegularPages "Type" "zanfu") (where .Site.RegularPages "Type" "xuekan") | shuffle }}
{{ $categories := slice }}
{{ range .Site.Taxonomies.categories.ByCount }}
{{ with .Pages | shuffle }}
{{ $cate := . }}
{{ range first 1 $cate }}
{{ $categories =  $categories | append  . }}
{{ end }}
{{ end }}
{{ end }}
{{ $others := intersect  $categories  $other }}
<ul>
{{  range first 5 $others | shuffle }}
<li><a href="{{ .Permalink }}">{{- .Title  | safeHTML -}}</a></li>
  {{ end }}
</ul>
{{ with .PrevInSection }}
<h2>上篇</h2>
  <a href="{{ .RelPermalink }}">{{- .Title  | safeHTML -}}</a>
  {{- end }}
  {{ with .NextInSection }}
  <h2>下篇</h2>
    <a href="{{ .RelPermalink }}">{{- .Title  | safeHTML -}}</a>
{{- end }}
</div>
</div>

<div class="u-wrapper">
  <div class="u-padding">
{{ partial "comments.html" . }}
</div></div>
  </article>
</main>
</body>
    {{ partial "footer.html" . }}
{{ end }}
